version: '3.8'

services:
  # ===================
  # PostgreSQL Database
  # ===================
  postgres:
    image: postgres:16-alpine
    container_name: auth-jwt-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_NAME:-auth_jwt_db}
      POSTGRES_USER: ${DB_USERNAME:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-admin}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      # Persist database data
      - postgres_data:/var/lib/postgresql/data
      # Initialize database with DDL script
      - ./src/main/resources/ddl.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME:-admin} -d ${DB_NAME:-auth_jwt_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - auth-jwt-network

  # =======================
  # Spring Boot Application
  # =======================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: auth-jwt-app
    restart: unless-stopped
    ports:
      - "${SERVER_PORT:-8080}:8080"
    environment:
      # Server configuration
      SERVER_PORT: 8080

      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-auth_jwt_db}
      DB_USERNAME: ${DB_USERNAME:-admin}
      DB_PASSWORD: ${DB_PASSWORD:-admin}
      DB_POOL_SIZE: ${DB_POOL_SIZE:-20}
      DB_MIN_IDLE: ${DB_MIN_IDLE:-5}

      # JWT configuration
      JWT_SECRET: ${JWT_SECRET:-bvUPO4LP4QOLQhldziMpTRkoQOeT/kz6NjPUAoCQPHgU3MAZjU+BrFJe3wvVm7yUhiPgXO439/9zzVo1L4g+xQ==}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-900000}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-604800000}
      JWT_ISSUER: ${JWT_ISSUER:-auth-jwt-service}

      # Application configuration
      APP_TIMEZONE: ${APP_TIMEZONE:-Asia/Ho_Chi_Minh}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:4200}
      JPA_SHOW_SQL: ${JPA_SHOW_SQL:-false}

      # JVM optimization (will be used in JAVA_OPTS)
      JAVA_OPTS: >-
        -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:InitialRAMPercentage=50.0 -XX:+UseG1GC -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - auth-jwt-network
    # Resource limits for production
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

networks:
  auth-jwt-network:
    driver: bridge
    name: auth-jwt-network

volumes:
  postgres_data:
    driver: local
    name: auth-jwt-postgres-data
